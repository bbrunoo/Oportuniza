<div class="container">
  <div class="conteudo">

    <div class="conteudo-left">
      <div class="image-upload-area" (click)="fileInput.click()" (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)" (drop)="onDrop($event)" [class.dragging]="isDragging">
        <img *ngIf="previewUrl" [src]="previewUrl" alt="Preview da Imagem da Vaga" class="preview-image" />

        <div class="upload-placeholder" *ngIf="!previewUrl">
          <p><small>Arraste e solte a imagem aqui</small></p>
          <p class="upload-subtext">ou clique para selecionar</p>
        </div>
      </div>
      <input hidden type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" />
      <button type="button" class="btn btn-secondary mt-1" (click)="fileInput.click()">
        Escolher Imagem üñºÔ∏è
      </button>
    </div>

    <div class="conteudo-right">
      <div class="form-section post-as-section">
        <label class="input-label">Postar como</label>
        <div class="author-options">
          <div class="author-option" *ngIf="userProfile && !userProfile.isCompany"
            [ngClass]="{ active: selectedAuthorId === userProfile.id }" (click)="selectAuthor(userProfile.id)">
            <img [src]="userProfile.imageUrl || '../../../../assets/etapas/perfil.png'" class="author-image">
            <p class="author-name">{{ userProfile.name }}</p>
          </div>
          <div class="author-option" *ngFor="let company of userCompanies"
            [ngClass]="{ active: selectedAuthorId === company.id }" (click)="selectAuthor(company.id)">
            <img [src]="company.imageUrl" class="author-image" alt="Company Image">
            <p class="author-name">{{ company.name }}</p>
          </div>
        </div>
      </div>

      <form (ngSubmit)="post()" #publicationForm="ngForm">
        <div class="form-section">
          <label class="input-label">T√≠tulo da Vaga</label>
          <div class="option-buttons tag-buttons">
            <button type="button" class="option-button"
              [ngClass]="{ active: publication.title === 'Estamos Contratando' }"
              (click)="selectTitle('Estamos Contratando')">
              Estamos Contratando
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.title === 'Vaga em Aberto' }"
              (click)="selectTitle('Vaga em Aberto')">
              Vaga em Aberto
            </button>
            <button type="button" class="option-button"
              [ngClass]="{ active: publication.title === 'Oportunidade Dispon√≠vel' }"
              (click)="selectTitle('Oportunidade Dispon√≠vel')">
              Oportunidade Dispon√≠vel
            </button>
          </div>
        </div>

        <div class="form-section">
          <label class="input-label">Descri√ß√£o</label>
          <textarea name="description" [(ngModel)]="publication.description"
            placeholder="Descreva a vaga, requisitos, etc." required rows="8" class="form-textarea"></textarea>
        </div>

        <div class="form-section">
          <label class="input-label">Sal√°rio</label>
          <div class="option-buttons">
            <button type="button" class="option-button" [ngClass]="{ active: publication.salary === 'At√© R$1.000,00' }"
              (click)="selectSalary('At√© R$1.000,00')">
              At√© R$1.000,00
            </button>
            <button type="button" class="option-button"
              [ngClass]="{ active: publication.salary === 'R$1.000,00 a R$2.000,00' }"
              (click)="selectSalary('R$1.000,00 a R$2.000,00')">
              R$1.000,00 a R$2.000,00
            </button>
            <button type="button" class="option-button"
              [ngClass]="{ active: publication.salary === 'Acima de R$2.000,00' }"
              (click)="selectSalary('Acima de R$2.000,00')">
              Acima de R$2.000,00
            </button>
          </div>
        </div>

        <div class="form-section">
          <label class="input-label">Turno</label>
          <div class="option-buttons">
            <button type="button" class="option-button" [ngClass]="{ active: publication.shift === 'Matutino' }"
              (click)="selectShift('Matutino')">
              Matutino
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.shift === 'Vespertino' }"
              (click)="selectShift('Vespertino')">
              Vespertino
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.shift === 'Noturno' }"
              (click)="selectShift('Noturno')">
              Noturno
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.shift === 'Turno' }"
              (click)="selectShift('Turno')">
              Turno Var√≠avel
            </button>
          </div>
        </div>

        <div class="form-section">
          <label class="input-label">Contrato</label>
          <div class="option-buttons">
            <button type="button" class="option-button" [ngClass]="{ active: publication.contract === 'CLT' }"
              (click)="selectContract('CLT')">
              CLT
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.contract === 'Autonomo' }"
              (click)="selectContract('Autonomo')">
              Aut√¥nomo
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.contract === 'Est√°gio' }"
              (click)="selectContract('Est√°gio')">
              Est√°gio
            </button>
            <button type="button" class="option-button" [ngClass]="{ active: publication.contract === 'PJ' }"
              (click)="selectContract('PJ')">
              PJ
            </button>
          </div>
        </div>

        <div class="form-inline-group">
          <div class="form-section inline-item">
            <label class="input-label">Data de Expira√ß√£o</label>
            <input type="date" [min]="today" name="expirationDate" [(ngModel)]="publication.expirationDate"
              class="form-input" />
          </div>

          <div class="form-section inline-item">
            <label class="input-label">Localiza√ß√£o</label>

            <input type="text" [value]="publication.local" placeholder="Selecione a cidade" readonly
              (click)="openCityModal()" class="form-input" />
          </div>

          <div class="modal-backdrop" *ngIf="cityModalOpen">
            <div class="modal">
              <h3>Selecione a cidade</h3>

              <input type="text" [formControl]="cityControl" placeholder="Digite para buscar" class="custom-input" />

              <ul *ngIf="filteredCities.length > 0" class="custom-options">
                <li *ngFor="let city of filteredCities" (click)="selectCityFromModal(city)" class="custom-option">
                  {{ city.name }}
                </li>
              </ul>

              <button class="close-btn" (click)="closeCityModal()">Fechar</button>
            </div>
          </div>
        </div>

        <div class="submit-section">
          <button class="submit-button" type="submit" [disabled]="publicationForm.invalid || isSubmitting">
            <span *ngIf="!isSubmitting">Salvar</span>
            <span *ngIf="isSubmitting">Salvando...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="email-verification-overlay" *ngIf="verificationModalOpen">
  <div class="email-verification-modal">
    <h3>Verifica√ß√£o de Publica√ß√£o</h3>

    <div *ngIf="!codeSent" class="email-step">
      <p>Ser√° enviado um c√≥digo de verifica√ß√£o para o e-mail usado no seu cadastro.</p>
      <p><strong>{{ userProfile?.email }}</strong></p>
      <div class="email-actions">
        <button class="email-btn email-btn-cancel" (click)="closeVerificationModal()">Cancelar</button>
        <button class="email-btn email-btn-send" (click)="sendEmailCode()">Enviar C√≥digo</button>
      </div>
    </div>

    <div *ngIf="codeSent" class="verify-card">
      <header class="verify-header">
        <p class="verify-subtitle">
          Enviamos um c√≥digo de {{ codeLength }} d√≠gitos para
          <strong>{{ userProfile?.email }}</strong>.
        </p>
        <p class="verify-subtitle">Digite o c√≥digo abaixo para continuar.</p>
      </header>

      <div class="otp-group">
        <input #d1 class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" [(ngModel)]="codeInputs[0]"
          (input)="onInput($event, 0)" (keydown)="onKeydown($event, 0)" />
        <input #d2 class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" [(ngModel)]="codeInputs[1]"
          (input)="onInput($event, 1)" (keydown)="onKeydown($event, 1)" />
        <input #d3 class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" [(ngModel)]="codeInputs[2]"
          (input)="onInput($event, 2)" (keydown)="onKeydown($event, 2)" />
        <input #d4 class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" [(ngModel)]="codeInputs[3]"
          (input)="onInput($event, 3)" (keydown)="onKeydown($event, 3)" />
        <input #d5 class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" [(ngModel)]="codeInputs[4]"
          (input)="onInput($event, 4)" (keydown)="onKeydown($event, 4)" />
        <input #d6 class="otp-input" maxlength="1" inputmode="numeric" pattern="[0-9]*" [(ngModel)]="codeInputs[5]"
          (input)="onInput($event, 5)" (keydown)="onKeydown($event, 5)" />
      </div>

      <div class="resend-row">
        <span class="muted">N√£o recebeu?</span>
        <button class="btn btn-link" [disabled]="cooldown > 0" (click)="resendCode()">
          {{ cooldown > 0 ? 'Reenviar em ' + cooldown + 's' : 'Reenviar c√≥digo' }}
        </button>
      </div>

      <div class="email-actions">
        <button class="email-btn email-btn-cancel" (click)="closeVerificationModal()">Cancelar</button>
        <button class="email-btn email-btn-confirm" [disabled]="isVerifying" (click)="confirmPublication()">
          {{ isVerifying ? 'Verificando...' : 'Confirmar e Publicar' }}
        </button>
      </div>
    </div>
  </div>
</div>
